version: 2.1

parameters:
  node_image:
    type: string
    default: "cimg/node:22.15.1"

commands:
  install-deps:
    steps:
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pnpm-lock.yaml" }}
            - v1-dependencies-
      - run: corepack enable
      - run: pnpm config set store-dir ~/.pnpm-store
      - run: pnpm install
      - save_cache:
          paths:
             - node_modules
              - ~/.pnpm-store
          key: v1-dependencies-{{ checksum "pnpm-lock.yaml" }}

jobs:
  lint:
    docker:
      - image: << pipeline.parameters.node_image >>
    steps:
      - checkout
      - install-deps
      - run: pnpm run lint

  check:
    docker:
      - image: << pipeline.parameters.node_image >>
    steps:
      - checkout
      - install-deps
      - run: pnpm run check

  typecheck:
    docker:
      - image: << pipeline.parameters.node_image >>
    steps:
      - checkout
      - install-deps
      - run: pnpm run typecheck
        
  build:
    docker:
      - image: << pipeline.parameters.node_image >>
    steps:
      - checkout
      - install-deps
      - run: pnpm run build

  test:
    docker:
      - image: << pipeline.parameters.node_image >>
    steps:
      - checkout
      - install-deps
      - run: pnpm test

  release:
    docker:
      - image: << pipeline.parameters.node_image >>
    steps:
      - checkout
      - install-deps
      - run:
          name: Configure Git User
          command: |
            git config --global user.email "m.gabriele.dev@gmail.com"
            git config --global user.name "Matteo Gabriele"
      - run:
          name: Configure NPM Authentication
          command: |
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
      - run: npx semantic-release

workflows:
  version: 2
  verify-test-and-release:
    jobs:
      - lint
      - check:
          requires:
            - lint
      - typecheck:
          requires:
            - check
      - build:
          requires:
            - typecheck
      - test:
          requires:
            - build
      - release:
          requires:
            - test
          filters:
            branches:
              only: master
